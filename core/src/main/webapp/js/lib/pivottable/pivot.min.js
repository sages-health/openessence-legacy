(function(){var g,E,F,t,A,G,H,I,B,J,K,s,u,C,D,w,x=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1},r={}.hasOwnProperty,v=function(a,b){return function(){return a.apply(b,arguments)}};g=jQuery;F=function(a){var b,c;b=(a+"").split(".");a=b[0];c=1<b.length?"."+b[1]:"";for(b=/(\d+)(\d{3})/;b.test(a);)a=a.replace(b,"$1,$2");return a+c};s=function(a,b){null==a&&(a=3);null==b&&(b=1);return function(c){return 0===c||isNaN(c)||!isFinite(c)?"":F((b*c).toFixed(a))}};
t={sum:function(a,b){null==a&&(a=3);null==b&&(b=1);return function(c){var d;d=c[0];return function(){return{sum:0,push:function(b){if(!isNaN(parseFloat(b[d])))return this.sum+=parseFloat(b[d])},value:function(){return this.sum},format:s(a,b),label:"Sum of "+d}}}},average:function(a,b){null==a&&(a=3);null==b&&(b=1);return function(c){var d;d=c[0];return function(){return{sum:0,len:0,push:function(b){if(!isNaN(parseFloat(b[d])))return this.sum+=parseFloat(b[d]),this.len++},value:function(){return this.sum/
this.len},format:s(a,b),label:"Average of "+d}}}},sumOverSum:function(a,b){null==a&&(a=3);null==b&&(b=1);return function(c){var d,f;f=c[0];d=c[1];return function(){return{sumNum:0,sumDenom:0,push:function(b){isNaN(parseFloat(b[f]))||(this.sumNum+=parseFloat(b[f]));if(!isNaN(parseFloat(b[d])))return this.sumDenom+=parseFloat(b[d])},value:function(){return this.sumNum/this.sumDenom},format:s(a,b),label:""+f+"/"+d}}}},sumOverSumBound80:function(a,b,c){null==a&&(a=3);null==b&&(b=1);null==c&&(c=!0);return function(d){var f,
e;e=d[0];f=d[1];return function(){return{sumNum:0,sumDenom:0,push:function(b){isNaN(parseFloat(b[e]))||(this.sumNum+=parseFloat(b[e]));if(!isNaN(parseFloat(b[f])))return this.sumDenom+=parseFloat(b[f])},value:function(){return(0.821187207574908/this.sumDenom+this.sumNum/this.sumDenom+1.2815515655446004*(c?1:-1)*Math.sqrt(0.410593603787454/(this.sumDenom*this.sumDenom)+this.sumNum*(1-this.sumNum/this.sumDenom)/(this.sumDenom*this.sumDenom)))/(1+1.642374415149816/this.sumDenom)},format:s(a,b),label:""+
(c?"Upper":"Lower")+" Bound of "+e+"/"+f}}}}};A={count:function(){return function(){return{count:0,push:function(){return this.count++},value:function(){return this.count},format:s(0),label:"Count"}}},countUnique:function(a){var b;b=a[0];return function(){return{uniq:[],push:function(c){var a;if(a=c[b],0>x.call(this.uniq,a))return this.uniq.push(c[b])},value:function(){return this.uniq.length},format:s(0),label:"Count Unique "+b}}},listUnique:function(a){var b;b=a[0];return function(){return{uniq:[],
push:function(c){var a;if(a=c[b],0>x.call(this.uniq,a))return this.uniq.push(c[b])},value:function(){return this.uniq.join(", ")},format:function(b){return b},label:"List Unique "+b}}},intSum:t.sum(0),sum:t.sum(3),average:t.average(3),sumOverSum:t.sumOverSum(3),ub80:t.sumOverSumBound80(3,1,!0),lb80:t.sumOverSumBound80(3,1,!1)};C={Table:function(a){return u(a)},"Table Barchart":function(a){return u(a).barchart()},Heatmap:function(a){return u(a).heatmap()},"Row Heatmap":function(a){return u(a).heatmap("rowheatmap")},
"Col Heatmap":function(a){return u(a).heatmap("colheatmap")}};K="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");H="Sun Mon Tue Wed Thu Fri Sat".split(" ");w=function(a){return("0"+a).substr(-2,2)};g.pivotUtilities={aggregatorTemplates:t,aggregators:A,renderers:C,derivers:{bin:function(a,b){return function(c){return c[a]-c[a]%b}},dateFormat:function(a,b){return function(c){var d;d=new Date(Date.parse(c[a]));return b.replace(/%(.)/g,function(b,a){switch(a){case "y":return d.getFullYear();
case "m":return w(d.getMonth()+1);case "n":return K[d.getMonth()];case "d":return w(d.getDate());case "w":return H[d.getDay()];case "x":return d.getDay();case "H":return w(d.getHours());case "M":return w(d.getMinutes());case "S":return w(d.getSeconds());default:return"%"+a}})}}}};I=function(a,b,c){var d,f,e;for(d in b)f=b[d],a[d]=null!=(e=f(a))?e:a[d];for(d in a)r.call(a,d)&&null==a[d]&&(a[d]="null");return c(a)};B=function(a,b,c){var d,f,e,l,p,k,n,h,m;d=function(a){return I(a,b,c)};if("[object Function]"===
Object.prototype.toString.call(a))return a(d);if(Array.isArray(a)){if(Array.isArray(a[0])){m=[];for(e in a)if(r.call(a,e)&&(f=a[e],0<e)){k={};h=a[0];for(l in h)r.call(h,l)&&(p=h[l],k[p]=f[l]);m.push(d(k))}return m}l=[];f=0;for(e=a.length;f<e;f++)k=a[f],l.push(d(k));return l}n=[];g("thead > tr > th",a).each(function(b){return n.push(g(this).text())});return g("tbody > tr",a).each(function(b){k={};g("td",this).each(function(b){return k[n[b]]=g(this).text()});return d(k)})};G=function(a){var b;b=[];
B(a,{},function(a){return b.push(a)});return b};E=function(){function a(b,a,d){this.aggregator=b;this.colAttrs=a;this.rowAttrs=d;this.getAggregator=v(this.getAggregator,this);this.flattenKey=v(this.flattenKey,this);this.getRowKeys=v(this.getRowKeys,this);this.getColKeys=v(this.getColKeys,this);this.sortKeys=v(this.sortKeys,this);this.arrSort=v(this.arrSort,this);this.natSort=v(this.natSort,this);this.tree={};this.rowKeys=[];this.colKeys=[];this.flatRowKeys=[];this.flatColKeys=[];this.rowTotals={};
this.colTotals={};this.allTotal=this.aggregator();this.sorted=!1}a.prototype.natSort=function(b,a){var d,f,e,g,p,k;f=/(\d+)|(\D+)/g;p=/\d/;k=/^0/;if("number"===typeof b||"number"===typeof a)return isNaN(b)?1:isNaN(a)?-1:b-a;d=String(b).toLowerCase();e=String(a).toLowerCase();if(d===e)return 0;if(!p.test(d)||!p.test(e))return d>e?1:-1;d=d.match(f);for(e=e.match(f);d.length&&e.length;)if(f=d.shift(),g=e.shift(),f!==g)return p.test(f)&&p.test(g)?f.replace(k,".0")-g.replace(k,".0"):f>g?1:-1;return d.length-
e.length};a.prototype.arrSort=function(b,a){return this.natSort(b.join(),a.join())};a.prototype.sortKeys=function(){this.sorted||(this.rowKeys.sort(this.arrSort),this.colKeys.sort(this.arrSort));return this.sorted=!0};a.prototype.getColKeys=function(){this.sortKeys();return this.colKeys};a.prototype.getRowKeys=function(){this.sortKeys();return this.rowKeys};a.prototype.flattenKey=function(b){return b.join(String.fromCharCode(0))};a.prototype.processRecord=function(b){var a,d,f,e,g;a=function(){var a,
d,c,h;c=this.colAttrs;h=[];a=0;for(d=c.length;a<d;a++)g=c[a],h.push(b[g]);return h}.call(this);e=function(){var a,d,c,h;c=this.rowAttrs;h=[];a=0;for(d=c.length;a<d;a++)g=c[a],h.push(b[g]);return h}.call(this);f=this.flattenKey(e);d=this.flattenKey(a);this.allTotal.push(b);0!==e.length&&(0>x.call(this.flatRowKeys,f)&&(this.rowKeys.push(e),this.flatRowKeys.push(f)),this.rowTotals[f]||(this.rowTotals[f]=this.aggregator()),this.rowTotals[f].push(b));0!==a.length&&(0>x.call(this.flatColKeys,d)&&(this.colKeys.push(a),
this.flatColKeys.push(d)),this.colTotals[d]||(this.colTotals[d]=this.aggregator()),this.colTotals[d].push(b));if(0!==a.length&&0!==e.length)return f in this.tree||(this.tree[f]={}),d in this.tree[f]||(this.tree[f][d]=this.aggregator()),this.tree[f][d].push(b)};a.prototype.getAggregator=function(a,c){var d,f;f=this.flattenKey(a);d=this.flattenKey(c);d=0===a.length&&0===c.length?this.allTotal:0===a.length?this.colTotals[d]:0===c.length?this.rowTotals[f]:this.tree[f][d];return null!=d?d:{value:function(){return null},
format:function(){return""}}};return a}();J=function(a,b,c,d,f,e){var g;g=new E(d,b,c);B(a,e,function(a){if(f(a))return g.processRecord(a)});return g};D=function(a,b,c){var d,f,e,g;if(0!==b){d=!0;for(e=f=0;0<=c?f<=c:f>=c;e=0<=c?++f:--f)a[b-1][e]!==a[b][e]&&(d=!1);if(d)return-1}for(d=0;b+d<a.length;){f=!1;for(e=g=0;0<=c?g<=c:g>=c;e=0<=c?++g:--g)a[b][e]!==a[b+d][e]&&(f=!0);if(f)break;d++}return d};u=function(a){var b,c,d,f,e,l,p,k,n,h,m;d=a.colAttrs;k=a.rowAttrs;n=a.getRowKeys();f=a.getColKeys();p=
g("<table class='table table-bordered pvtTable'>");for(l in d)if(r.call(d,l)){c=d[l];m=g("<tr>");0===parseInt(l)&&0!==k.length&&m.append(g("<th>").attr("colspan",k.length).attr("rowspan",d.length));m.append(g("<th class='pvtAxisLabel'>").text(c));for(e in f)r.call(f,e)&&(b=f[e],h=D(f,parseInt(e),parseInt(l)),-1!==h&&(h=g("<th class='pvtColLabel'>").text(b[l]).attr("colspan",h),parseInt(l)===d.length-1&&0!==k.length&&h.attr("rowspan",2),m.append(h)));0===parseInt(l)&&m.append(g("<th class='pvtTotalLabel'>").text("Totals").attr("rowspan",
d.length+(0===k.length?0:1)));p.append(m)}if(0!==k.length){m=g("<tr>");for(e in k)r.call(k,e)&&(c=k[e],m.append(g("<th class='pvtAxisLabel'>").text(c)));h=g("<th>");0===d.length&&h.addClass("pvtTotalLabel").text("Totals");m.append(h);p.append(m)}for(e in n)if(r.call(n,e)){c=n[e];m=g("<tr>");for(l in c)r.call(c,l)&&(b=c[l],h=D(n,parseInt(e),parseInt(l)),-1!==h&&(h=g("<th class='pvtRowLabel'>").text(b).attr("rowspan",h),parseInt(l)===k.length-1&&0!==d.length&&h.attr("colspan",2),m.append(h)));for(l in f)r.call(f,
l)&&(b=f[l],b=a.getAggregator(c,b),h=b.value(),m.append(g("<td class='pvtVal row"+e+" col"+l+"'>").text(b.format(h)).data("value",h)));c=a.getAggregator(c,[]);h=c.value();m.append(g("<td class='pvtTotal rowTotal'>").text(c.format(h)).data("value",h).data("for","row"+e));p.append(m)}m=g("<tr>");h=g("<th class='pvtTotalLabel'>").text("Totals");h.attr("colspan",k.length+(0===d.length?0:1));m.append(h);for(l in f)r.call(f,l)&&(b=f[l],c=a.getAggregator([],b),h=c.value(),m.append(g("<td class='pvtTotal colTotal'>").text(c.format(h)).data("value",
h).data("for","col"+l)));c=a.getAggregator([],[]);h=c.value();m.append(g("<td class='pvtGrandTotal'>").text(c.format(h)).data("value",h));p.append(m);p.data("dimensions",[n.length,f.length]);return p};g.fn.pivot=function(a,b){var c;c={cols:[],rows:[],filter:function(){return!0},aggregator:A.count(),derivedAttributes:{},renderer:u};b=g.extend(c,b);this.html(b.renderer(J(a,b.cols,b.rows,b.aggregator,b.filter,b.derivedAttributes)));return this};g.fn.pivotUI=function(a,b,c){var d,f,e,l,p,k,n,h,m,y,z,
q,t,s=this;null==c&&(c=!1);p={derivedAttributes:{},aggregators:A,renderers:C,hiddenAttributes:[],cols:[],rows:[],vals:[]};k=this.data("pivotUIOptions");h=null==k||c?g.extend(p,b):k;a=G(a);b=function(){var b,c;b=a[0];c=[];for(n in b)r.call(b,n)&&c.push(n);return c}();c=h.derivedAttributes;for(e in c)r.call(c,e)&&0>x.call(b,e)&&b.push(e);f={};e=0;for(c=b.length;e<c;e++)q=b[e],f[q]={};B(a,h.derivedAttributes,function(a){var b,c,d;d=[];for(n in a)r.call(a,n)&&(b=a[n],null==b&&(b="null"),null==(c=f[n])[b]&&
(c[b]=0),d.push(f[n][b]++));return d});c=g("<table class='table table-bordered' cellpadding='5'>");p=g("<td>");z=g("<select id='renderer'>").bind("change",function(){return y()});e=h.renderers;for(q in e)r.call(e,q)&&z.append(g("<option>").val(q).text(q));p.append(z);l=g("<td id='unused' class='pvtAxisContainer pvtHorizList'>");k=0;for(t=b.length;k<t;k++)e=b[k],0>x.call(h.hiddenAttributes,e)&&function(a){var b,c,d,h,e,m,k;b=Object.keys(f[a]).length;c=g("<nobr>").text(a);h=g("<div>").css({"z-index":100,
width:"280px",height:"350px",overflow:"scroll",border:"1px solid gray",background:"white",display:"none",position:"absolute",padding:"20px"});h.append(g("<strong>").text(""+b+" values for "+a));if(50<b)h.append(g("<p>").text("(too many to list)"));else for(b=g("<p>"),b.append(g("<button>").text("Select All").bind("click",function(){return h.find("input").attr("checked",!0)})),b.append(g("<button>").text("Select None").bind("click",function(){return h.find("input").attr("checked",!1)})),h.append(b),
k=Object.keys(f[a]).sort(),e=0,m=k.length;e<m;e++)n=k[e],d=f[a][n],b=g("<label>"),b.append(g("<input type='checkbox' class='pvtFilter'>").attr("checked",!0).data("filter",[a,n])),b.append(g("<span>").text(""+n+" ("+d+")")),h.append(g("<p>").append(b));c.bind("dblclick",function(a){h.css({left:a.pageX,top:a.pageY}).toggle();h.bind("click",function(a){return a.stopPropagation()});return g(document).one("click",function(){y();return h.toggle()})});return l.append(g("<li class='label label-info' id='axis_"+
a.replace(/\s/g,"")+"'>").append(c).append(h))}(e);c.append(g("<tr>").append(p).append(l));e=g("<tr>");d=g("<select id='aggregator'>").css("margin-bottom","5px").bind("change",function(){return y()});b=h.aggregators;for(q in b)r.call(b,q)&&d.append(g("<option>").val(q).text(q));e.append(g("<td id='vals' class='pvtAxisContainer pvtHorizList'>").css("text-align","center").append(d).append(g("<br>")));e.append(g("<td id='cols' class='pvtAxisContainer pvtHorizList'>"));c.append(e);q=g("<tr>");q.append(g("<td valign='top' id='rows' class='pvtAxisContainer'>"));
m=g("<td valign='top'>");q.append(m);c.append(q);this.html(c);c=h.cols;e=0;for(b=c.length;e<b;e++)q=c[e],this.find("#cols").append(this.find("#axis_"+q.replace(/\s/g,"")));c=h.rows;e=0;for(b=c.length;e<b;e++)q=c[e],this.find("#rows").append(this.find("#axis_"+q.replace(/\s/g,"")));c=h.vals;b=0;for(e=c.length;b<e;b++)q=c[b],this.find("#vals").append(this.find("#axis_"+q.replace(/\s/g,"")));null!=h.aggregatorName&&this.find("#aggregator").val(h.aggregatorName);null!=h.rendererName&&this.find("#renderer").val(h.rendererName);
y=function(){var b,c,e;c={derivedAttributes:h.derivedAttributes,cols:[],rows:[]};e=[];s.find("#rows li nobr").each(function(){return c.rows.push(g(this).text())});s.find("#cols li nobr").each(function(){return c.cols.push(g(this).text())});s.find("#vals li nobr").each(function(){return e.push(g(this).text())});c.aggregator=h.aggregators[d.val()](e);c.renderer=h.renderers[z.val()];b=[];s.find("input.pvtFilter").not(":checked").each(function(){return b.push(g(this).data("filter"))});c.filter=function(a){var c,
d,h;h=0;for(d=b.length;h<d;h++)if(c=b[h],n=c[0],c=c[1],a[n]===c)return!1;return!0};m.pivot(a,c);return s.data("pivotUIOptions",{cols:c.cols,rows:c.rows,vals:e,hiddenAttributes:h.hiddenAttributes,renderers:h.renderers,aggregators:h.aggregators,derivedAttributes:h.derivedAttributes,aggregatorName:d.val(),rendererName:z.val()})};y();this.find(".pvtAxisContainer").sortable({connectWith:".pvtAxisContainer",items:"li"}).bind("sortstop",y);return this};g.fn.heatmap=function(a){var b,c,d,f,e=this;null==a&&
(a="heatmap");c=this.data("dimensions");f=c[0];d=c[1];b=function(a,b,c){var d;d=function(){switch(a){case "red":return function(a){return"ff"+a+a};case "green":return function(a){return""+a+"ff"+a};case "blue":return function(a){return""+a+a+"ff"}}}();return function(a){a=(255-Math.round(255*(a-b)/(c-b))).toString(16).split(".")[0];1===a.length&&(a=0+a);return d(a)}};c=function(a,c){var d,f,h;f=function(b){return e.find(a).each(function(){var a;a=g(this).data("value");if(null!=a&&isFinite(a))return b(a,
g(this))})};h=[];f(function(a){return h.push(a)});d=b(c,Math.min.apply(Math,h),Math.max.apply(Math,h));return f(function(a,b){return b.css("background-color","#"+d(a))})};switch(a){case "heatmap":c(".pvtVal","red");break;case "rowheatmap":for(d=a=0;0<=f?a<f:a>f;d=0<=f?++a:--a)c(".pvtVal.row"+d,"red");break;case "colheatmap":for(f=a=0;0<=d?a<d:a>d;f=0<=d?++a:--a)c(".pvtVal.col"+f,"red")}c(".pvtTotal.rowTotal","red");c(".pvtTotal.colTotal","red");return this};g.fn.barchart=function(){var a,b,c,d,f=
this;c=this.data("dimensions")[0];a=function(a){var b,c,d,n;b=function(b){return f.find(a).each(function(){var a;a=g(this).data("value");if(null!=a&&isFinite(a))return b(a,g(this))})};n=[];b(function(a){return n.push(a)});c=Math.max.apply(Math,n);d=function(a){return 100*a/(1.4*c)};return b(function(a,b){var c,e;c=b.text();e=g("<div>").css({position:"relative",height:"55px"});e.append(g("<div>").css({position:"absolute",bottom:0,left:0,right:0,height:d(a)+"%","background-color":"gray"}));e.append(g("<div>").text(c).css({position:"relative",
"padding-left":"5px","padding-right":"5px"}));return b.css({padding:0,"padding-top":"5px","text-align":"center"}).html(e)})};for(b=d=0;0<=c?d<c:d>c;b=0<=c?++d:--d)a(".pvtVal.row"+b);a(".pvtTotal.colTotal");return this}}).call(this);
//# sourceMappingURL=pivot.js.map
